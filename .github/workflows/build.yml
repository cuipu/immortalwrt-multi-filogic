name: build-ax6000-immortalwrt

permissions: write-all # 开启 Release 写入权限

on:
    repository_dispatch:
    workflow_dispatch: # 支持手动点击运行
    schedule:
        - cron: 0 20 * * 3 # 每周四凌晨 04:00 (北京时间) 自动运行

env:
    REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6 # padavanonly 专为 mt798x 优化的 6.6 内核仓库
    REPO_BRANCH: openwrt-24.10-6.6 # 源码分支
    PLATFORM_FILE: configs/ax6000/ax6000.config # 存放设备基础配置 (Target/Subtarget)
    CONFIG_FILE: configs/ax6000/packages-ax6000.config # 存放插件配置 (LuCI apps)
    FEEDS_CONF: feeds.conf.default # feeds 配置文件
    SETTINGS_SH: scripts/init-settings.sh # 修改默认 IP 等脚本
    UPLOAD_RELEASE: true # 编译完成后上传到 Release
    TZ: Asia/Shanghai # 时区

jobs:
    build:
        runs-on: ubuntu-24.04 # Use latest Ubuntu for compatibility with ImmortalWrt build tools

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4 # Checks out this repo to access custom configs and scripts
            - name: Create Swap
              run: |
                  sudo fallocate -l 8G /swapfile
                  sudo chmod 600 /swapfile
                  sudo mkswap /swapfile
                  sudo swapon /swapfile
            - name: Install build dependencies
              run: |
                  # Update package list and install required tools for OpenWrt/ImmortalWrt compilation.
                  # These are standard dependencies for building from source.
                  sudo apt update -y
                  sudo apt full-upgrade -y
                  sudo apt install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
                    bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext-base gettext \
                    git gperf haveged help2man intltool libc-dev libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
                    libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
                    libssl-dev libtool lrzsz mkisofs msmtp ninja-build patch pkgconf python3 python3-pyelftools \
                    python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglify-js \
                    upx-ucl unzip vim wget xmlto xxd zlib1g-dev
                  sudo apt autoremove --purge -y
                  sudo apt clean -y

            - name: Clone ImmortalWrt source code
              run: |
                  # Clone the ImmortalWrt repository at version 24.10.4 (latest stable as of Dec 2025).
                  # This ensures the build is on version 24+ as required.
                  git clone https://github.com/immortalwrt/immortalwrt.git -b v24.10.4 openwrt
                  cd openwrt
                  git rev-parse HEAD  # Log commit hash for reproducibility

            - name: Update and install feeds
              working-directory: openwrt
              run: |
                  # Update package feeds and install them. This pulls in all necessary packages, including those for PPPoE.
                  ./scripts/feeds update -a
                  ./scripts/feeds install -a

            - name: Apply configuration
              working-directory: openwrt
              run: |
                  # Copy base config (common settings for all builds).
                  cp ../common/base.config .config
                  # Append device-specific config for AX6000 (target selection, kernel tweaks).
                  cat ../common/config/ax6000/ax6000.config >> .config
                  # Append package-specific config for AX6000 (necessary and recommended plugins).
                  cat ../common/config/ax6000/packages-ax6000.config >> .config
                  # Expand the config to full defconfig for building.
                  make defconfig

            - name: Download dependencies
              working-directory: openwrt
              run: |
                  # Download all source packages in parallel for faster build.
                  make download -j$(nproc)
                  # Clean up any failed downloads.
                  find dl -size -1024c -exec rm -f {} \;

            - name: Compile firmware
              working-directory: openwrt
              run: |
                  # Build the firmware with verbose output for debugging.
                  # Uses all CPU cores for speed.
                  make -j$(nproc) V=s

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: immortalwrt-ax6000-firmware
                  path: openwrt/bin/targets/mediatek/filogic/*
                  retention-days: 7 # Keep artifacts for 7 days
