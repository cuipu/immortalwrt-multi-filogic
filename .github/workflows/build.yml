name: build-multi-filogic

permissions: write-all

on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: 0 20 * * 3   # æ¯å‘¨è‡ªåŠ¨

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: openwrt-24.10-6.6
  COMMON_BASE: common/base.config      # å…¬å…±åŸºç¡€é…ç½®
  COMMON_PACKAGES: common/packages.config # æ‰€æœ‰è®¾å¤‡å…±äº«çš„åŸºç¡€é…ç½®
  TZ: Asia/Shanghai
  UPLOAD_RELEASE: true

jobs:
  build:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        device: [ax6000, gl-mt6000, cmcc-rax3000m, qihoo-360t7]  # è¿™é‡Œåˆ—å‡ºä½ è¦æž„å»ºçš„è®¾å¤‡æ–‡ä»¶å¤¹åï¼ŒåŠ æ–°è®¾å¤‡ç›´æŽ¥åŠ è¿™é‡Œ
      fail-fast: false  # ä¸€ä¸ªè®¾å¤‡å¤±è´¥ä¸å½±å“å…¶ä»–

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      # ï¼ˆåŒä½ ä¹‹å‰ workflow çš„åˆå§‹åŒ–éƒ¨åˆ†ï¼Œçœç•¥...ï¼‰

    - name: å…‹éš†æºç 
      # ï¼ˆåŒä¹‹å‰ï¼‰

    - name: å®‰è£… feeds
      # ï¼ˆåŒä¹‹å‰ï¼‰

    - name: åº”ç”¨é…ç½®ï¼ˆå…¬å…± + å½“å‰è®¾å¤‡ï¼‰
      run: |
        cd openwrt
        # åº”ç”¨å…¬å…±åŸºç¡€
        cat ../$COMMON_BASE >> .config
        cat ../$COMMON_PACKAGES >> .config
        # åº”ç”¨è®¾å¤‡ä¸“å±ž
        cat ../devices/${{ matrix.device }}/device.config >> .config
        # å¦‚æžœè®¾å¤‡æœ‰è‡ªå®šä¹‰åŒ…ï¼Œè¦†ç›–æˆ–è¿½åŠ 
        [ -f ../devices/${{ matrix.device }}/packages.config ] && cat ../devices/${{ matrix.device }}/packages.config >> .config
        # å¤åˆ¶å…¬å…± files
        [ -d ../common/files ] && cp -r ../common/files .
        # å¤åˆ¶è®¾å¤‡ filesï¼ˆè¦†ç›–å…¬å…±ï¼‰
        [ -d ../devices/${{ matrix.device }}/files ] && cp -r ../devices/${{ matrix.device }}/files .
        make defconfig

    - name: ä¸‹è½½ & ç¼–è¯‘
      # ï¼ˆåŒä½ ä¹‹å‰ workflow çš„ä¸‹è½½ã€ç¼–è¯‘å·¥å…·é“¾ã€å†…æ ¸ã€æ’ä»¶ã€å›ºä»¶éƒ¨åˆ†ï¼‰

    - name: æ•´ç†å¹¶ä¸Šä¼  Releaseï¼ˆæŒ‰è®¾å¤‡ï¼‰
      if: success()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages *.buildinfo *.json *.manifest
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

        # ç”Ÿæˆè®¾å¤‡ä¸“å±ž Release æè¿°
        echo -e "ðŸŽ‰ ${{ matrix.device }} å›ºä»¶\nâœ… ImmortalWrt 24.10-6.6\né»˜è®¤ IP: 192.168.6.1" > release.txt

        RELEASE_TAG=$(date +"%Y%m%d")_${{ matrix.device }}
        gh release create $RELEASE_TAG --title "${{ matrix.device }} å›ºä»¶" --notes-file release.txt $FIRMWARE/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}