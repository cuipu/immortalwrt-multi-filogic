name: build-multi-filogic

permissions: write-all

on:
    workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    schedule:
        - cron: 0 20 * * 3 # æ¯å‘¨è‡ªåŠ¨

env:
    REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
    REPO_BRANCH: openwrt-24.10-6.6
    COMMON_BASE: common/base.config # å…¬å…±åŸºç¡€é…ç½®
    COMMON_PACKAGES: common/packages.config # æ‰€æœ‰è®¾å¤‡å…±äº«çš„åŸºç¡€é…ç½®
    TZ: Asia/Shanghai
    UPLOAD_RELEASE: true

jobs:
    build:
        runs-on: ubuntu-24.04
        strategy:
            matrix:
                device: [ax6000] # è¿™é‡Œåˆ—å‡ºä½ è¦æž„å»ºçš„è®¾å¤‡æ–‡ä»¶å¤¹åï¼ŒåŠ æ–°è®¾å¤‡ç›´æŽ¥åŠ è¿™é‡Œ
            fail-fast: false # ä¸€ä¸ªè®¾å¤‡å¤±è´¥ä¸å½±å“å…¶ä»–

        steps:
            - name: Checkout
              uses: actions/checkout@main

            - name: åˆå§‹åŒ–çŽ¯å¢ƒ
              env:
                  DEBIAN_FRONTEND: noninteractive # éžäº¤äº’æ¨¡å¼ï¼Œé¿å… apt æç¤º
              run: |
                  # è¿è¡Œæ¸…ç†ç£ç›˜è„šæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  chmod +x $FREE_DISK_SH && $FREE_DISK_SH
                  # æ›´æ–° apt å¹¶å‡çº§ç³»ç»Ÿ
                  sudo -E apt-get -qq update -y
                  sudo -E apt-get -qq full-upgrade -y
                  # è¿è¡ŒçŽ¯å¢ƒè„šæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  chmod +x $ENV_SH && $ENV_SH
                  # æ¸…ç†ä¸å¿…è¦çš„ç›®å½•ä»¥èŠ‚çœç©ºé—´
                  sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
                  sudo timedatectl set-timezone "$TZ"
                  # æ¸…ç† Docker é•œåƒå’Œå®¹å™¨
                  docker image prune -a -f
                  docker container prune -f
                  # åˆ›å»ºå·¥ä½œç›®å½•
                  sudo mkdir -p /workdir
                  sudo chown $USER:$GROUPS /workdir
            - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ1 # æ­¥éª¤ï¼šæ˜¾ç¤ºç£ç›˜ä½¿ç”¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
              if: (!cancelled())
              run: df -hT
            - name: å…‹éš†æºç 
              working-directory: /workdir
              run: |
                  # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„æºç ï¼ˆ--depth 1 åªå…‹éš†æœ€æ–°æäº¤ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
                  git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt
                  # åˆ›å»ºç¬¦å·é“¾æŽ¥åˆ° GitHub å·¥ä½œåŒº
                  ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

            - name: è®¾ç½® VERSION çŽ¯å¢ƒå˜é‡ # æ­¥éª¤ï¼šæå–ç‰ˆæœ¬å·
              run: echo "VERSION=${REPO_BRANCH#*-}" >> $GITHUB_ENV

            - name: å®‰è£… feeds
              run: |
                  cd openwrt
                  ./scripts/feeds update -a  # æ›´æ–°æ‰€æœ‰ feeds
                  ./scripts/feeds install -a  # å®‰è£…æ‰€æœ‰ feeds

            - name: åº”ç”¨é…ç½®ï¼ˆå…¬å…± + å½“å‰è®¾å¤‡ï¼‰
              run: |
                  cd openwrt
                  # åº”ç”¨å…¬å…±åŸºç¡€
                  cat ../$COMMON_BASE >> .config
                  cat ../$COMMON_PACKAGES >> .config
                  # åº”ç”¨è®¾å¤‡ä¸“å±ž
                  cat ../devices/${{ matrix.device }}/device.config >> .config
                  # å¦‚æžœè®¾å¤‡æœ‰è‡ªå®šä¹‰åŒ…ï¼Œè¦†ç›–æˆ–è¿½åŠ 
                  [ -f ../devices/${{ matrix.device }}/packages.config ] && cat ../devices/${{ matrix.device }}/packages.config >> .config
                  # å¤åˆ¶å…¬å…± files
                  [ -d ../common/files ] && cp -r ../common/files .
                  # å¤åˆ¶è®¾å¤‡ filesï¼ˆè¦†ç›–å…¬å…±ï¼‰
                  [ -d ../devices/${{ matrix.device }}/files ] && cp -r ../devices/${{ matrix.device }}/files .
                  make defconfig

            - name: å¯¼å…¥è¡¥ä¸å’Œé…ç½® & æ‰§è¡Œè„šæœ¬ # æ­¥éª¤ï¼šåº”ç”¨é…ç½®å’Œè„šæœ¬
              run: |
                  # å¦‚æžœæœ‰ files ç›®å½•ï¼Œå¤åˆ¶åˆ° openwrtï¼ˆè‡ªå®šä¹‰æ–‡ä»¶ï¼Œå¦‚ rootfsï¼‰
                  [ -d files ] && mv files openwrt/files || echo "files not found"
                  # è¿½åŠ è®¾å¤‡é…ç½®ï¼ˆax6000.configï¼‰
                  [ -f $PLATFORM_FILE ] && cat $PLATFORM_FILE >> openwrt/.config
                  # è¿½åŠ åŒ…é…ç½®ï¼ˆpackages.configï¼‰
                  [ -f $CONFIG_FILE ] && cat $CONFIG_FILE >> openwrt/.config
                  cd openwrt
                  # è¿è¡Œè‡ªå®šä¹‰è®¾ç½®è„šæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
                  # è¿è¡ŒåŒ…è„šæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH
                  # è¿è¡Œ Clash æ ¸å¿ƒè„šæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
                  chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH
            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ2 # è°ƒè¯•ï¼šç£ç›˜ä½¿ç”¨
              if: (!cancelled())
              run: df -hT
            - name: ç¼–è¯‘å·¥å…·é“¾ # æ­¥éª¤ï¼šç¼–è¯‘å·¥å…·é“¾
              id: mtools
              run: |
                  cd openwrt
                  make defconfig
                  echo -e "$(($(nproc)+1)) thread compile"  # ä½¿ç”¨ CPU æ ¸æ•° +1 çº¿ç¨‹
                  make tools/compile -j$(($(nproc)+1)) || make tools/compile -j1 V=s  # å…ˆå¤šçº¿ç¨‹ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹
                  make toolchain/compile -j$(($(nproc)+1)) || make toolchain/compile -j1 V=s
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ3_1 # è°ƒè¯•
              if: (!cancelled())
              run: df -hT

            - name: æ¸…é™¤å·¥å…·é“¾ç¼–è¯‘ä¸­é—´äº§ç‰©... # æ­¥éª¤ï¼šæ¸…ç†ç©ºé—´
              if: steps.mtools.outputs.status == 'success' && !cancelled()
              run: |
                  cd openwrt
                  rm -rf dl/*  # æ¸…ç†ä¸‹è½½
                  rm -rf build_dir/toolchain-*  # æ¸…ç†å·¥å…·é“¾ä¸­é—´æ–‡ä»¶

            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ3_2 # è°ƒè¯•
              if: (!cancelled())
              run: df -hT

            - name: ç¼–è¯‘å†…æ ¸ # æ­¥éª¤ï¼šç¼–è¯‘å†…æ ¸
              id: mkernel
              if: steps.mtools.outputs.status == 'success' && !cancelled()
              run: |
                  cd openwrt
                  echo -e "$(($(nproc)+1)) thread compile"
                  make target/linux/compile -j$(($(nproc)+1)) || make target/linux/compile -j1 V=s
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ4 # è°ƒè¯•
              if: (!cancelled())
              run: df -hT

            - name: ç¼–è¯‘æ’ä»¶ # æ­¥éª¤ï¼šç¼–è¯‘åŒ…
              id: mpackage
              if: steps.mkernel.outputs.status == 'success' && !cancelled()
              run: |
                  cd openwrt
                  echo -e "$(($(nproc)+1)) thread compile"
                  make package/compile -j$(($(nproc)+1)) || make package/compile -j1 V=s
                  make package/install -j$(nproc) || make package/install -j1 V=s
                  make package/index  # ç”ŸæˆåŒ…ç´¢å¼•
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ5 # è°ƒè¯•
              if: (!cancelled())
              run: df -hT

            - name: æ¸…é™¤æ’ä»¶ç¼–è¯‘æ–‡ä»¶ # æ­¥éª¤ï¼šæ¸…ç†åŒ…ä¸­é—´æ–‡ä»¶
              id: cpackage
              if: steps.mpackage.outputs.status == 'success' && !cancelled()
              run: |
                  cd openwrt
                  rm -rf build_dir/target-*/host  # æ¸…ç†ä¸»æœºå·¥å…·
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ6 # è°ƒè¯•
              if: (!cancelled())
              run: df -hT

            - name: ç¼–è¯‘å›ºä»¶ # æ­¥éª¤ï¼šç¼–è¯‘æœ€ç»ˆå›ºä»¶
              id: compile
              if: steps.cpackage.outputs.status == 'success' && !cancelled()
              run: |
                  cd openwrt
                  echo -e "$(($(nproc)+1)) thread compile"
                  make target/install -j$(nproc) || make target/install -j1 V=s
                  make json_overview_image_info  # ç”Ÿæˆé•œåƒä¿¡æ¯
                  make checksum  # ç”Ÿæˆæ ¡éªŒå’Œ
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ7 # è°ƒè¯•
              if: (!cancelled())
              run: df -hT

            - name: ä¸Šä¼  bin ç›®å½• # æ­¥éª¤ï¼šä¸Šä¼  artifactï¼ˆå¦‚æžœå¯ç”¨ï¼‰
              uses: actions/upload-artifact@main
              if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
              with:
                  name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
                  path: openwrt/bin

            - name: æ•´ç†æ–‡ä»¶ # æ­¥éª¤ï¼šæ¸…ç†è¾“å‡ºç›®å½•ï¼Œåªä¿ç•™å›ºä»¶
              id: organize
              if: steps.compile.outputs.status == 'success' && !cancelled()
              run: |
                  cd openwrt/bin/targets/*/*
                  # ç§»é™¤ä¸å¿…è¦çš„æ–‡ä»¶
                  rm -rf *.buildinfo
                  rm -rf *.json
                  rm -rf *.manifest
                  rm -rf packages
                  echo "FIRMWARE=$PWD" >> $GITHUB_ENV  # è®¾ç½®å›ºä»¶è·¯å¾„çŽ¯å¢ƒå˜é‡
                  echo "status=success" >> $GITHUB_OUTPUT
            - name: æ•´ç†å¹¶ä¸Šä¼  Releaseï¼ˆæŒ‰è®¾å¤‡ï¼‰
              if: success()
              run: |
                  cd openwrt/bin/targets/*/*
                  rm -rf packages *.buildinfo *.json *.manifest
                  echo "FIRMWARE=$PWD" >> $GITHUB_ENV

                  # ç”Ÿæˆè®¾å¤‡ä¸“å±ž Release æè¿°
                  echo -e "ðŸŽ‰ ${{ matrix.device }} å›ºä»¶\nâœ… ImmortalWrt 24.10-6.6\né»˜è®¤ IP: 192.168.6.1" > release.txt

                  RELEASE_TAG=$(date +"%Y%m%d")_${{ matrix.device }}
                  gh release create $RELEASE_TAG --title "${{ matrix.device }} å›ºä»¶" --notes-file release.txt $FIRMWARE/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
