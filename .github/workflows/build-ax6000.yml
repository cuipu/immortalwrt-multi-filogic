name: Build ImmortalWrt for Redmi AX6000

permissions: write-all

on:
  workflow_dispatch:
  schedule:
    - cron: "0 20 * * 3"

env:
  TZ: Asia/Shanghai
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
  REPO_BRANCH: openwrt-24.10-6.6
  DEVICE_CONFIG: configs/ax6000/ax6000.config
  PACKAGES_CONFIG: configs/ax6000/packages-ax6000.config
  INIT_SETTINGS: scripts/init-settings.sh
  UPLOAD_RELEASE: true
  KEEP_LATEST_RELEASES: 15
  KEEP_MINIMUM_RUNS: 3

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 最大化释放磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: 手动额外清理
        run: |
          sudo rm -rf /opt/hostedtoolcache /usr/local/.ghcup /usr/local/share/boost
          sudo docker system prune -af --volumes || true
          sudo rm -rf /home/runner/actions-runner/_diag || true
          df -hT

      - name: 超级清理磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo rm -rf /usr/local/.ghcup /usr/local/share/boost /opt/containerd
          sudo docker image prune -af || true
          sudo docker system prune -af --volumes || true
          sudo rm -rf /home/runner/actions-runner/_diag || true
          df -hT

      - name: 创建 16GB Swap
        run: |
          sudo fallocate -l 16G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo swapon --show

      - name: 安装编译依赖
        run: |
          sudo apt update -y
          sudo apt install -y build-essential ccache flex gawk gettext git libncurses5-dev \
            libssl-dev python3 python3-pyelftools python3-setuptools rsync subversion \
            swig texinfo unzip upx-ucl wget zlib1g-dev xsltproc

      - name: 克隆源码
        run: |
          git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
          cd openwrt
          echo "源码 Commit: $(git rev-parse HEAD)"

      - name: 开启 ccache 缓存
        uses: klever1988/cachewrtbuild@main
        with:
          ccache: "true"
          mixkey: "ax6000-24.10-6.6"
          prefix: ${{ github.workspace }}/openwrt

      - name: 更新并安装 feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 加载配置 & 处理内核新选项
        working-directory: openwrt
        run: |
          cat ../${{ env.DEVICE_CONFIG }} > .config
          cat ../${{ env.PACKAGES_CONFIG }} >> .config
          if [ -f ../${{ env.INIT_SETTINGS }} ]; then
            bash ../${{ env.INIT_SETTINGS }}
          fi
          make defconfig
          yes "" | make kernel_oldconfig || true

      - name: 下载源码
        working-directory: openwrt
        run: |
          make download -j1
          find dl -size -1024c -exec rm -f {} \;

      - name: 空间检查（下载后）
        run: df -hT

      # ========= 分步编译 =========
      - name: 编译工具链
        id: tools
        working-directory: openwrt
        run: |
          make tools/compile -j$(nproc) || make tools/compile -j1 V=s
          make toolchain/compile -j$(nproc) || make toolchain/compile -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 清理工具链中间产物（保留 staging_dir）
        if: always()
        working-directory: openwrt
        run: |
          rm -rf build_dir/toolchain-*
          df -hT

      - name: 编译内核
        id: kernel
        if: steps.tools.outputs.status == 'success'
        working-directory: openwrt
        run: |
          make target/linux/compile -j$(nproc) || make target/linux/compile -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 修复 GMP 配置（跳过 autoreconf 警告）
        if: always()
        working-directory: openwrt
        run: |
          GMP_DIR=$(find build_dir/target-aarch64_cortex-a53_musl -type d -name "gmp-*" 2>/dev/null | head -1)
          if [ -n "$GMP_DIR" ]; then
            touch "$GMP_DIR/.configured" "$GMP_DIR/configure"
            echo "Skipped autoreconf for GMP in $GMP_DIR"
          fi

      - name: 编译插件包（单线程 + 忽略 GMP 错误）
        id: package
        if: steps.kernel.outputs.status == 'success'
        working-directory: openwrt
        run: |
          make package/compile -j1 V=s IGNORE_ERRORS="m n gmp" || make package/compile -j1 V=s
          make package/install -j1 V=s
          make package/index
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 清理插件中间产物
        if: always()
        working-directory: openwrt
        run: |
          rm -rf build_dir/target-*/packages tmp
          df -hT

      - name: 编译固件
        id: firmware
        if: steps.package.outputs.status == 'success'
        working-directory: openwrt
        run: |
          make target/install -j$(nproc) || make target/install -j1 V=s
          make checksum
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 最终大清理
        if: always()
        working-directory: openwrt
        run: |
          rm -rf build_dir/ staging_dir/ tmp/
          df -hT

      - name: 空间检查（最终）
        run: df -hT

      # ========= 上传与 Release =========
      - name: 上传固件到 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-AX6000-${{ github.run_id }}
          path: openwrt/bin/targets/mediatek/filogic/*

      - name: 生成 Release 信息
        id: release_info
        if: env.UPLOAD_RELEASE == 'true' && steps.firmware.outputs.status == 'success'
        run: |
          DATE=$(date +'%Y%m%d-%H%M')
          echo "tag=ax6000-$DATE" >> $GITHUB_OUTPUT
          echo "name=Redmi AX6000 ImmortalWrt 自动构建 $DATE" >> $GITHUB_OUTPUT
          cat > release_body.txt << EOF
          - 仓库：${{ env.REPO_URL }}
          - 分支：${{ env.REPO_BRANCH }}
          - 型号：Redmi AX6000 (ubootmod)
          - 内核：6.6 (padavanonly mt798x 优化)
          - 包含：PPPoE、TurboACC-mtk、Argon 主题等
          - 构建时间：$DATE
          - 触发者：${{ github.actor }}
          EOF

      - name: 上传到 GitHub Release
        if: env.UPLOAD_RELEASE == 'true' && steps.release_info.outputs.tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.name }}
          body_path: release_body.txt
          files: openwrt/bin/targets/mediatek/filogic/*
          draft: false
          prerelease: false

      - name: 删除旧 Release
        if: env.UPLOAD_RELEASE == 'true' && steps.firmware.outputs.status == 'success'
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: ${{ env.KEEP_LATEST_RELEASES }}
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 删除旧 Workflow 运行记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: ${{ env.KEEP_MINIMUM_RUNS }}