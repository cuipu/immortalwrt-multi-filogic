name: Build ImmortalWrt for Redmi AX6000 # 工作流名称

# 触发方式
on:
    workflow_dispatch: # 支持 GitHub 页面手动点击运行
    repository_dispatch: # 支持外部仓库通过 API 触发（可选）
    schedule:
        - cron: "0 20 * * 3" # 每周四 北京时间 04:00 自动构建（可删除或修改）

# 全局环境变量（方便统一管理与修改）
env:
    TZ: Asia/Shanghai # 时区设置为中国上海，避免日志时间错乱
    REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6 # 源码仓库（padavanonly 维护的 mt798x 专用分支，内核 6.6，AX6000 性能最佳）
    REPO_BRANCH: openwrt-24.10-6.6 # 源码分支（基于 ImmortalWrt 24.10 的 6.6 内核优化版）
    CONFIG_DEVICE: configs/ax6000/ax6000.config # 设备目标配置文件路径（选择 mediatek/filogic + Redmi AX6000）
    CONFIG_PACKAGES: configs/ax6000/packages-ax6000.config # 插件包配置文件路径（LuCI 插件、PPPoE 等）
    INIT_SETTINGS_SCRIPT: scripts/init-settings.sh # 可选：修改默认 IP、密码、主机名等脚本路径（如果有的话）
    UPLOAD_ARTIFACT: true # 是否上传编译产物到 Artifacts（true/false）
    COMPILE_THREADS: 1 # 编译线程数（GitHub runner 内存有限，强烈建议先用 1，成功后再改为 4）

jobs:
    build:
        runs-on: ubuntu-24.04 # 使用最新的 Ubuntu 系统，确保工具链兼容性

        steps:
            - name: Checkout repository # 检出本仓库代码（获取 configs、scripts 等自定义文件）
              uses: actions/checkout@v4

            - name: 清理磁盘空间（释放更多空间防止空间不足） # GitHub runner 默认磁盘较小，先清理无用内容
              run: |
                  sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
                  sudo docker image prune -af || true
                  df -h

            - name: 创建 8GB Swap（防止 OOM 内存溢出） # 编译 OpenWrt 极易 OOM，添加 Swap 基本能彻底解决
              run: |
                  sudo fallocate -l 8G /swapfile
                  sudo chmod 600 /swapfile
                  sudo mkswap /swapfile
                  sudo swapon /swapfile
                  sudo swapon --show

            - name: 安装编译依赖（精简版，专治 ubuntu-24.04）
              run: |
                  sudo apt update -y
                  sudo apt install -y build-essential ccache flex gawk gettext git libncurses5-dev \
                  libssl-dev python3 python3-pyelftools python3-setuptools rsync subversion \
                  swig texinfo unzip upx-ucl wget zlib1g-dev xsltproc

            - name: 克隆源码 # 克隆指定的 padavanonly mt798x 优化仓库与分支
              run: |
                  git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} openwrt
                  cd openwrt
                  echo "当前源码 Commit ID:"
                  git rev-parse HEAD

            - name: 更新并安装 Feeds # 更新所有软件源并安装包索引
              working-directory: openwrt
              run: |
                  ./scripts/feeds update -a
                  ./scripts/feeds install -a

            - name: 加载自定义配置 # 合并设备配置 + 插件配置
              working-directory: openwrt
              run: |
                  # 先写入设备目标配置（覆盖式，确保 target 正确）
                  cat ../${{ env.CONFIG_DEVICE }} > .config
                  # 追加插件包配置
                  cat ../${{ env.CONFIG_PACKAGES }} >> .config
                  # 如果有 init-settings.sh（常用于改默认 IP 为 192.168.10.1 等），执行它
                  if [ -f ../${{ env.INIT_SETTINGS_SCRIPT }} ]; then
                    bash ../${{ env.INIT_SETTINGS_SCRIPT }}
                  fi
                  # 展开配置
                  make defconfig

            - name: 下载源码包 # 并行下载所有包的源码
              working-directory: openwrt
              run: |
                  make download -j$(nproc)
                  find dl -size -1024c -exec rm -f {} \;

            - name: 编译固件 # 核心编译步骤（使用 env 中定义的线程数，1 最稳）
              working-directory: openwrt
              run: |
                  make -j${{ env.COMPILE_THREADS }} V=s || make -j1 V=s  # 如果多线程失败自动降为单线程

            - name: 上传编译产物到 Artifacts # 编译成功后上传固件，方便下载
              if: ${{ env.UPLOAD_ARTIFACT == 'true' }}
              uses: actions/upload-artifact@v4
              with:
                  name: ImmortalWrt-Redmi-AX6000-Firmware
                  path: openwrt/bin/targets/mediatek/filogic/*
                  retention-days: 10 # Artifacts 保留 10 天
