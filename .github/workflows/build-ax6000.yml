name: build-ax6000-immortalwrt

permissions: write-all # å¼€å¯ Release å†™å…¥æƒé™

on:
    repository_dispatch:
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
    schedule:
        - cron: 0 20 * * 3 # æ¯å‘¨å››å‡Œæ™¨ 04:00 (åŒ—äº¬æ—¶é—´) è‡ªåŠ¨è¿è¡Œ

env:
    REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6 # padavanonly ä¸“ä¸º mt798x ä¼˜åŒ–çš„ 6.6 å†…æ ¸ä»“åº“
    REPO_BRANCH: openwrt-24.10-6.6 # æºç åˆ†æ”¯
    PLATFORM_FILE: configs/ax6000/ax6000.config # å­˜æ”¾è®¾å¤‡åŸºç¡€é…ç½® (Target/Subtarget)
    CONFIG_FILE: configs/ax6000/packages-ax6000.config # å­˜æ”¾æ’ä»¶é…ç½® (LuCI apps)
    FEEDS_CONF: feeds.conf.default # feeds é…ç½®æ–‡ä»¶
    SETTINGS_SH: scripts/init-settings.sh # ä¿®æ”¹é»˜è®¤ IP ç­‰è„šæœ¬
    UPLOAD_RELEASE: true # ç¼–è¯‘å®Œæˆåä¸Šä¼ åˆ° Release
    TZ: Asia/Shanghai # æ—¶åŒº

jobs:
    build:
        runs-on: ubuntu-22.04 # å»ºè®®ä½¿ç”¨ 22.04ï¼Œå¯¹æ—§æ’ä»¶ç¼–è¯‘å™¨çš„å…¼å®¹æ€§æ¯” 24.04 æ›´ç¨³

        steps:
            - name: æ£€å‡ºé¡¹ç›®ä»£ç 
              uses: actions/checkout@v4

            - name: åˆå§‹åŒ–ç¯å¢ƒ
              env:
                  DEBIAN_FRONTEND: noninteractive
              run: |
                  # æ¸…ç†ç£ç›˜ç©ºé—´å¹¶å®‰è£…ç¼–è¯‘ä¾èµ– (é’ˆå¯¹ Ubuntu ç³»ç»Ÿä¼˜åŒ–)
                  sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
                  sudo -E apt-get -qq update
                  sudo -E apt-get -qq install $(curl -fsSL is.gd)
                  sudo -E apt-get -qq autoremove --purge
                  sudo -E apt-get -qq clean
                  sudo timedatectl set-timezone "$TZ"
                  sudo mkdir -p /workdir
                  sudo chown $USER:$GROUPS /workdir

            - name: å…‹éš†æºç 
              working-directory: /workdir
              run: |
                  # --depth 1 æµ…å…‹éš†ï¼Œæ˜¾è‘—åŠ å¿« Actions è¿è¡Œé€Ÿåº¦
                  git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt
                  ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

            - name: æ›´æ–°å¹¶å®‰è£… Feeds
              run: |
                  cd openwrt
                  ./scripts/feeds update -a
                  ./scripts/feeds install -a

            - name: å¯¼å…¥è‡ªå®šä¹‰é…ç½®ä¸è„šæœ¬
              run: |
                  # 1. å¤åˆ¶ files ç›®å½• (å¦‚æœå­˜åœ¨) åˆ°ç¼–è¯‘æ ¹ç›®å½•
                  [ -d files ] && mv files openwrt/files || echo "files ç›®å½•æœªæ‰¾åˆ°"
                  # 2. åˆå¹¶è®¾å¤‡åŸºç¡€é…ç½®å’Œæ’ä»¶é…ç½®åˆ° .config
                  [ -f $PLATFORM_FILE ] && cat $PLATFORM_FILE >> openwrt/.config
                  [ -f $CONFIG_FILE ] && cat $CONFIG_FILE >> openwrt/.config
                  # 3. è¿è¡Œåˆå§‹åŒ–è„šæœ¬ (å¦‚ä¿®æ”¹ IP åœ°å€: 192.168.6.1)
                  cd openwrt
                  [ -f $GITHUB_WORKSPACE/$SETTINGS_SH ] && chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
                  # 4. ç‰¹æ®Šå¤„ç†ï¼šé’ˆå¯¹ Linux 6.6 å†…æ ¸ï¼Œé€šè¿‡ defconfig è‡ªåŠ¨ä¿®æ­£ä¾èµ–
                  make defconfig

            - name: ä¸‹è½½ä¾èµ–åŒ… (Download)
              id: package
              run: |
                  cd openwrt
                  # ä½¿ç”¨ V=s å¯ä»¥è®°å½•å…·ä½“å“ªä¸ªåŒ…ä¸‹è½½å¤±è´¥
                  make download -j8 V=s
                  # æ¸…ç†ä¸‹è½½å¤±è´¥äº§ç”Ÿçš„ 1KB ä»¥ä¸‹çš„å°æ–‡ä»¶
                  find dl -size -1024c -exec rm -f {} \;

            - name: è‡ªåŠ¨åŒ–å®Œæ•´ç¼–è¯‘ (æ ¸å¿ƒæ­¥éª¤)
              id: compile
              run: |
                  cd openwrt
                  echo -e "$(nproc) çº¿ç¨‹å¼€å§‹ç¼–è¯‘..."
                  # ç­–ç•¥ï¼šç›´æ¥æ‰§è¡Œå…¨ç¼–è¯‘ã€‚Makefile ä¼šè‡ªåŠ¨å¤„ç† tools -> toolchain -> target ä¾èµ–ã€‚
                  # è‹¥å¤šçº¿ç¨‹å¤±è´¥ (Error 2)ï¼Œåˆ™åˆ‡æ¢ä¸ºå•çº¿ç¨‹å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿— (V=s) æ–¹ä¾¿æ’æŸ¥ã€‚
                  make -j$(nproc) || make -j1 V=s
                  echo "status=success" >> $GITHUB_OUTPUT
                  echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

            - name: æ£€æŸ¥ç©ºé—´å ç”¨
              if: (!cancelled())
              run: df -hT

            - name: æ•´ç†å¹¶ç­›é€‰å›ºä»¶
              id: organize
              if: steps.compile.outputs.status == 'success' && !cancelled()
              run: |
                  # è¿›å…¥å›ºä»¶ç”Ÿæˆç›®å½• (MT7986 å¹³å°)
                  cd openwrt/bin/targets/mediatek/filogic/
                  # ç§»é™¤ç¼–è¯‘ä¸­é—´äº§ç‰©å’Œæ ¡éªŒæ–‡ä»¶ï¼Œåªä¿ç•™åˆ·æœºå›ºä»¶
                  rm -rf packages *.buildinfo *.json *.manifest
                  echo "FIRMWARE=$PWD" >> $GITHUB_ENV
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: ç”Ÿæˆ Release æ ‡ç­¾ä¸æè¿°
              id: tag
              if: steps.organize.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
              run: |
                  echo "release_tag=$(date +"%Y.%m.%d")-AX6000" >> $GITHUB_OUTPUT
                  touch release.txt
                  echo "ğŸš€ Redmi AX6000 è‡ªå®šä¹‰å›ºä»¶" >> release.txt
                  echo "ğŸ“‚ æºç ä»“åº“: $REPO_URL" >> release.txt
                  echo "ğŸ“Œ é»˜è®¤ IP: 192.168.6.1 (éœ€è„šæœ¬æ”¯æŒ)" >> release.txt
                  echo "status=success" >> $GITHUB_OUTPUT

            - name: å‘å¸ƒå›ºä»¶åˆ° GitHub Release
              uses: softprops/action-gh-release@v2
              if: steps.tag.outputs.status == 'success' && !cancelled()
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.tag.outputs.release_tag }}
                  body_path: release.txt
                  files: ${{ env.FIRMWARE }}/*

            - name: æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
              uses: Mattraks/delete-workflow-runs@v2
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  repository: ${{ github.repository }}
                  retain_days: 1
                  keep_minimum_runs: 3
