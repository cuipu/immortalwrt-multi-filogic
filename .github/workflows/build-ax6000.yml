# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#
# è¿™ä¸ª workflow ä¸“é—¨ä¸º Redmi AX6000-ubootmod æ„å»º ImmortalWrt 24.10 ç‰ˆæœ¬ã€‚
# å®ƒä¼šå…‹éš† padavanonly çš„ mt798x-24.10 æºç ï¼ˆåŒ…å«é—­æº MTK é©±åŠ¨ï¼‰ã€‚
# è¾“å‡ºï¼šå›ºä»¶æ–‡ä»¶ä¸Šä¼ åˆ° GitHub Releaseï¼Œä¾¿äºä¸‹è½½ã€‚
# è¿è¡Œè§¦å‘ï¼šæ‰‹åŠ¨ï¼ˆworkflow_dispatchï¼‰æˆ–å®šæ—¶ï¼ˆæ¯å‘¨ä¸‰ï¼‰ã€‚

name: build-ax6000  # workflow åç§°

permissions: write-all  # å…è®¸ä¸Šä¼ åˆ° Release

on:
  repository_dispatch:  # æ”¯æŒè¿œç¨‹è§¦å‘
  workflow_dispatch:     # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆåœ¨ Actions é¡µé¢ç‚¹å‡» Run workflowï¼‰
  schedule:
    - cron: 0 20 * * 3  # æ¯å‘¨å›› 04:00 åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰è‡ªåŠ¨è¿è¡Œä¸€æ¬¡

env:
  FREE_DISK_SH: scripts/free_disk_space.sh  # æ¸…ç†ç£ç›˜è„šæœ¬è·¯å¾„ï¼ˆå¯é€‰ï¼Œå¦‚æœä½ æœ‰è¿™ä¸ªè„šæœ¬ï¼‰
  ENV_SH: scripts/environment.sh            # ç¯å¢ƒåˆå§‹åŒ–è„šæœ¬è·¯å¾„ï¼ˆå¯é€‰ï¼‰
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10  # æºç ä»“åº“ï¼špadavanonly çš„ 24.10 mt798x ä¸“ç”¨ç‰ˆï¼ˆæ¨èï¼Œé—­æºé©±åŠ¨ï¼‰
  REPO_BRANCH: openwrt-24.10-6.6            # åˆ†æ”¯ï¼šopenwrt-24.10 + å†…æ ¸ 6.6
  PLATFORM_FILE: configs/ax6000.config      # è®¾å¤‡é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆæˆ‘ä»¬ç¨ååˆ›å»ºï¼Œåªé’ˆå¯¹ AX6000-ubootmodï¼‰
  CONFIG_FILE: configs/packages-ax6000.config      # è‡ªå®šä¹‰åŒ…é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆæˆ‘ä»¬ç¨ååˆ›å»ºï¼Œæ·»åŠ å¸¸ç”¨æ’ä»¶å¦‚ LuCIã€Passwallï¼‰
  SETTINGS_SH: scripts/init-settings.sh     # è‡ªå®šä¹‰è®¾ç½®è„šæœ¬è·¯å¾„ï¼Œä¿®æ”¹é»˜è®¤ç™»å½•IPï¼ˆå¯é€‰ï¼Œå¦‚æœä½ æœ‰ï¼‰
  PACKAGES_SH: scripts/packages.sh          # åŒ…å®‰è£…è„šæœ¬è·¯å¾„ï¼ˆå¯é€‰ï¼‰
  CLASH_CORE_SH: scripts/preset-clash-core-arm64-L.sh  # Clash æ ¸å¿ƒè„šæœ¬è·¯å¾„ï¼ˆå¯é€‰ï¼Œå¦‚æœéœ€è¦ OpenClashï¼‰
  UPLOAD_BIN_DIR: false                     # æ˜¯å¦ä¸Šä¼ æ•´ä¸ª bin ç›®å½•ï¼šfalseï¼ˆä¸ä¸Šä¼ ï¼Œåªä¸Šä¼ å›ºä»¶ï¼‰
  UPLOAD_FIRMWARE: false                    # æ˜¯å¦ä¸Šä¼  artifactï¼šfalseï¼ˆç›´æ¥ç”¨ Releaseï¼‰
  UPLOAD_RELEASE: true                      # æ˜¯å¦ä¸Šä¼ åˆ° GitHub Releaseï¼štrueï¼ˆæ¨èï¼Œæ–¹ä¾¿ä¸‹è½½ï¼‰
  TZ: Asia/Shanghai                         # æ—¶åŒºï¼šä¸­å›½ä¸Šæµ·

jobs:
  build:
    runs-on: ubuntu-24.04  # ä½¿ç”¨ Ubuntu 24.04 ç¯å¢ƒï¼ˆæœ€æ–°ï¼Œæ”¯æŒæ›´å¿«æ„å»ºï¼‰

    steps:
    - name: æ£€æŸ¥  # æ­¥éª¤ï¼šæ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¯å¢ƒ  # æ­¥éª¤ï¼šè®¾ç½®ç¯å¢ƒï¼Œæ¸…ç†ç©ºé—´ï¼Œå®‰è£…ä¾èµ–
      env:
        DEBIAN_FRONTEND: noninteractive  # éäº¤äº’æ¨¡å¼ï¼Œé¿å… apt æç¤º
      run: |
        # è¿è¡Œæ¸…ç†ç£ç›˜è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        chmod +x $FREE_DISK_SH && $FREE_DISK_SH
        # æ›´æ–° apt å¹¶å‡çº§ç³»ç»Ÿ
        sudo -E apt-get -qq update -y
        sudo -E apt-get -qq full-upgrade -y
        # è¿è¡Œç¯å¢ƒè„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        chmod +x $ENV_SH && $ENV_SH
        # æ¸…ç†ä¸å¿…è¦çš„ç›®å½•ä»¥èŠ‚çœç©ºé—´
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo timedatectl set-timezone "$TZ"
        # æ¸…ç† Docker é•œåƒå’Œå®¹å™¨
        docker image prune -a -f
        docker container prune -f
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ1  # æ­¥éª¤ï¼šæ˜¾ç¤ºç£ç›˜ä½¿ç”¨ï¼ˆè°ƒè¯•ç”¨ï¼‰
      if: (!cancelled())
      run: df -hT

    - name: å…‹éš†æºç   # æ­¥éª¤ï¼šå…‹éš† ImmortalWrt æºç 
      working-directory: /workdir
      run: |
        # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„æºç ï¼ˆ--depth 1 åªå…‹éš†æœ€æ–°æäº¤ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
        git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt
        # åˆ›å»ºç¬¦å·é“¾æ¥åˆ° GitHub å·¥ä½œåŒº
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: è®¾ç½® VERSION ç¯å¢ƒå˜é‡  # æ­¥éª¤ï¼šæå–ç‰ˆæœ¬å·
      run: echo "VERSION=${REPO_BRANCH#*-}" >> $GITHUB_ENV

    - name: å¼€å¯ç¼“å­˜  # æ­¥éª¤ï¼šå¯ç”¨ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»ºï¼ˆccache ç­‰ï¼‰
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'  # å¯ç”¨ ccache ç¼“å­˜
        mixkey: '${{ env.VERSION }}-ax6000'  # ç¼“å­˜é”®ï¼šç‰ˆæœ¬ + è®¾å¤‡
        prefix: ${{ github.workspace }}/openwrt  # ç¼“å­˜è·¯å¾„

    - name: å®‰è£… feeds  # æ­¥éª¤ï¼šæ›´æ–°å’Œå®‰è£… feedsï¼ˆè½¯ä»¶æºï¼‰
      run: |
        cd openwrt
        ./scripts/feeds update -a  # æ›´æ–°æ‰€æœ‰ feeds
        ./scripts/feeds install -a  # å®‰è£…æ‰€æœ‰ feeds

    - name: å¯¼å…¥è¡¥ä¸å’Œé…ç½® & æ‰§è¡Œè„šæœ¬  # æ­¥éª¤ï¼šåº”ç”¨é…ç½®å’Œè„šæœ¬
      run: |
        # å¦‚æœæœ‰ files ç›®å½•ï¼Œå¤åˆ¶åˆ° openwrtï¼ˆè‡ªå®šä¹‰æ–‡ä»¶ï¼Œå¦‚ rootfsï¼‰
        [ -d files ] && mv files openwrt/files || echo "files not found"
        # è¿½åŠ è®¾å¤‡é…ç½®ï¼ˆax6000.configï¼‰
        [ -f $PLATFORM_FILE ] && cat $PLATFORM_FILE >> openwrt/.config
        # è¿½åŠ åŒ…é…ç½®ï¼ˆpackages.configï¼‰
        [ -f $CONFIG_FILE ] && cat $CONFIG_FILE >> openwrt/.config
        cd openwrt
        # è¿è¡Œè‡ªå®šä¹‰è®¾ç½®è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
        # è¿è¡ŒåŒ…è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH
        # è¿è¡Œ Clash æ ¸å¿ƒè„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH

    - name: ä¸‹è½½æ–‡ä»¶  # æ­¥éª¤ï¼šç”Ÿæˆ defconfig å¹¶ä¸‹è½½ä¾èµ–
      run: |
        cd openwrt
        make defconfig  # æ‰©å±• .config
        make download -j8 V=10  # ä¸‹è½½åŒ…æºï¼ˆ-j8 å¤šçº¿ç¨‹ï¼‰
        # æ¸…ç†å°æ–‡ä»¶ï¼ˆå°äº 1KB çš„ä¸‹è½½å¤±è´¥æ–‡ä»¶ï¼‰
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ2  # è°ƒè¯•ï¼šç£ç›˜ä½¿ç”¨
      if: (!cancelled())
      run: df -hT

    - name: ç¼–è¯‘å·¥å…·é“¾  # æ­¥éª¤ï¼šç¼–è¯‘å·¥å…·é“¾
      id: mtools
      run: |
        cd openwrt
        make defconfig
        echo -e "$(($(nproc)+1)) thread compile"  # ä½¿ç”¨ CPU æ ¸æ•° +1 çº¿ç¨‹
        make tools/compile -j$(($(nproc)+1)) || make tools/compile -j1 V=s  # å…ˆå¤šçº¿ç¨‹ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹
        make toolchain/compile -j$(($(nproc)+1)) || make toolchain/compile -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ3_1  # è°ƒè¯•
      if: (!cancelled())
      run: df -hT

    - name: æ¸…é™¤å·¥å…·é“¾ç¼–è¯‘ä¸­é—´äº§ç‰©...  # æ­¥éª¤ï¼šæ¸…ç†ç©ºé—´
      if: steps.mtools.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        rm -rf dl/*  # æ¸…ç†ä¸‹è½½
        rm -rf build_dir/toolchain-*  # æ¸…ç†å·¥å…·é“¾ä¸­é—´æ–‡ä»¶

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ3_2  # è°ƒè¯•
      if: (!cancelled())
      run: df -hT

    - name: ç¼–è¯‘å†…æ ¸  # æ­¥éª¤ï¼šç¼–è¯‘å†…æ ¸
      id: mkernel
      if: steps.mtools.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make target/linux/compile -j$(($(nproc)+1)) || make target/linux/compile -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ4  # è°ƒè¯•
      if: (!cancelled())
      run: df -hT

    - name: ç¼–è¯‘æ’ä»¶  # æ­¥éª¤ï¼šç¼–è¯‘åŒ…
      id: mpackage
      if: steps.mkernel.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make package/compile -j$(($(nproc)+1)) || make package/compile -j1 V=s
        make package/install -j$(nproc) || make package/install -j1 V=s
        make package/index  # ç”ŸæˆåŒ…ç´¢å¼•
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ5  # è°ƒè¯•
      if: (!cancelled())
      run: df -hT

    - name: æ¸…é™¤æ’ä»¶ç¼–è¯‘æ–‡ä»¶  # æ­¥éª¤ï¼šæ¸…ç†åŒ…ä¸­é—´æ–‡ä»¶
      id: cpackage
      if: steps.mpackage.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        rm -rf build_dir/target-*/host  # æ¸…ç†ä¸»æœºå·¥å…·
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ6  # è°ƒè¯•
      if: (!cancelled())
      run: df -hT

    - name: ç¼–è¯‘å›ºä»¶  # æ­¥éª¤ï¼šç¼–è¯‘æœ€ç»ˆå›ºä»¶
      id: compile
      if: steps.cpackage.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make target/install -j$(nproc) || make target/install -j1 V=s
        make json_overview_image_info  # ç”Ÿæˆé•œåƒä¿¡æ¯
        make checksum  # ç”Ÿæˆæ ¡éªŒå’Œ
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ7  # è°ƒè¯•
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin ç›®å½•  # æ­¥éª¤ï¼šä¸Šä¼  artifactï¼ˆå¦‚æœå¯ç”¨ï¼‰
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: æ•´ç†æ–‡ä»¶  # æ­¥éª¤ï¼šæ¸…ç†è¾“å‡ºç›®å½•ï¼Œåªä¿ç•™å›ºä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        # ç§»é™¤ä¸å¿…è¦çš„æ–‡ä»¶
        rm -rf *.buildinfo
        rm -rf *.json
        rm -rf *.manifest
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV  # è®¾ç½®å›ºä»¶è·¯å¾„ç¯å¢ƒå˜é‡
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶ç›®å½•  # æ­¥éª¤ï¼šä¸Šä¼  artifactï¼ˆå¦‚æœå¯ç”¨ï¼‰
      uses: actions/upload-artifact@main
      if: env.UPLOAD_FIRMWARE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾  # æ­¥éª¤ï¼šåˆ›å»º Release æ ‡ç­¾å’Œæè¿°
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        VERSION1="${REPO_BRANCH#*-}"  # æå–ç‰ˆæœ¬
        # åˆ›å»º Release æè¿°æ–‡æœ¬
        echo -e "ğŸ‰ Redmi AX6000-ubootmod å›ºä»¶\nâœ… ImmortalWrt ${VERSION1} æºç \nâ—ï¸ é»˜è®¤ IP: 192.168.6.1\nâ—ï¸ åŒ…å«ä¸æ­» U-Boot æ”¯æŒ" >> release.txt
        # ç”Ÿæˆæ ‡ç­¾ï¼šæ—¥æœŸ + ç‰ˆæœ¬
        echo "release_tag=$(date +"%Y.%m.%d-${VERSION1}_ax6000")" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶åˆ°å‘å¸ƒ  # æ­¥éª¤ï¼šä¸Šä¼ å›ºä»¶åˆ° GitHub Release
      uses: softprops/action-gh-release@v2.0.4
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub ä»¤ç‰Œ
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}  # æ ‡ç­¾å
        body_path: release.txt  # æè¿°æ–‡ä»¶
        files: ${{ env.FIRMWARE }}/*  # ä¸Šä¼ æ‰€æœ‰å›ºä»¶æ–‡ä»¶ï¼ˆ.itb, .ubi ç­‰ï¼‰

    - name: åˆ é™¤ä»¥å‰å‘å¸ƒçš„å›ºä»¶  # æ­¥éª¤ï¼šæ¸…ç†æ—§ Releaseï¼ˆä¿ç•™æœ€è¿‘ 15 ä¸ªï¼‰
      uses: dev-drprasad/delete-older-releases@v0.3.3
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 15  # ä¿ç•™æœ€è¿‘ 15 ä¸ª Release
        delete_tags: true  # åˆ é™¤æ ‡ç­¾
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ é™¤ä»¥å‰çš„å·¥ä½œæµç¨‹  # æ­¥éª¤ï¼šæ¸…ç†æ—§ Actions è¿è¡Œè®°å½•ï¼ˆä¿ç•™æœ€è¿‘ 3 ä¸ªï¼Œ1 å¤©å†…ï¼‰
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 1  # ä¿ç•™ 1 å¤©
        keep_minimum_runs: 3  # è‡³å°‘ä¿ç•™ 3 ä¸ª